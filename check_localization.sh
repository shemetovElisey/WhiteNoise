#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª–Ω–æ—Ç—ã –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ WhiteNoise
# –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ –≤—Å–µ –∫–ª—é—á–∏ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤–æ –≤—Å–µ—Ö —è–∑—ã–∫–∞—Ö

set -e

echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ WhiteNoise..."
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∫–ª—é—á–µ–π –∏–∑ —Ñ–∞–π–ª–∞
extract_keys() {
    local file="$1"
    if [ -f "$file" ]; then
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–ª—é—á–∏ (—Å—Ç—Ä–æ–∫–∏ –≤–∏–¥–∞ "key" = "value";)
        grep '^[[:space:]]*"[^"]*"[[:space:]]*=' "$file" | sed 's/^[[:space:]]*"\([^"]*\)".*/\1/' | sort
    else
        echo "–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $file" >&2
        return 1
    fi
}

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
EN_FILE="WhiteNoise/Resources/en.lproj/Localizable.strings"
RU_FILE="WhiteNoise/Resources/ru.lproj/Localizable.strings"

if [ ! -f "$EN_FILE" ]; then
    echo -e "${RED}‚ùå –§–∞–π–ª –∞–Ω–≥–ª–∏–π—Å–∫–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: $EN_FILE${NC}"
    exit 1
fi

if [ ! -f "$RU_FILE" ]; then
    echo -e "${RED}‚ùå –§–∞–π–ª —Ä—É—Å—Å–∫–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω: $RU_FILE${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ –§–∞–π–ª—ã –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–∞–π–¥–µ–Ω—ã${NC}"
echo ""

# –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–ª—é—á–∏
echo "üìù –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π..."
EN_KEYS=$(extract_keys "$EN_FILE")
RU_KEYS=$(extract_keys "$RU_FILE")

# –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª—é—á–µ–π
EN_COUNT=$(echo "$EN_KEYS" | wc -l)
RU_COUNT=$(echo "$RU_KEYS" | wc -l)

echo -e "${GREEN}üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:${NC}"
echo "  –ê–Ω–≥–ª–∏–π—Å–∫–∏–π: $EN_COUNT –∫–ª—é—á–µ–π"
echo "  –†—É—Å—Å–∫–∏–π: $RU_COUNT –∫–ª—é—á–µ–π"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–ª–∏—á–∏—è
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–ª–∏—á–∏–π..."

# –ö–ª—é—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –Ω–æ –Ω–µ—Ç –≤ —Ä—É—Å—Å–∫–æ–º
MISSING_IN_RU=$(comm -23 <(echo "$EN_KEYS") <(echo "$RU_KEYS"))

# –ö–ª—é—á–∏, –∫–æ—Ç–æ—Ä—ã–µ –µ—Å—Ç—å –≤ —Ä—É—Å—Å–∫–æ–º, –Ω–æ –Ω–µ—Ç –≤ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º
MISSING_IN_EN=$(comm -13 <(echo "$EN_KEYS") <(echo "$RU_KEYS"))

# –û–±—â–∏–µ –∫–ª—é—á–∏
COMMON_KEYS=$(comm -12 <(echo "$EN_KEYS") <(echo "$RU_KEYS"))
COMMON_COUNT=$(echo "$COMMON_KEYS" | wc -l)

echo -e "${GREEN}‚úÖ –û–±—â–∏—Ö –∫–ª—é—á–µ–π: $COMMON_COUNT${NC}"

# –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
if [ -n "$MISSING_IN_RU" ]; then
    echo -e "${RED}‚ùå –ö–ª—é—á–∏, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –≤ —Ä—É—Å—Å–∫–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏:${NC}"
    echo "$MISSING_IN_RU" | sed 's/^/  - /'
    echo ""
fi

if [ -n "$MISSING_IN_EN" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –ö–ª—é—á–∏, –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –≤ –∞–Ω–≥–ª–∏–π—Å–∫–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏:${NC}"
    echo "$MISSING_IN_EN" | sed 's/^/  - /'
    echo ""
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—É—Å—Ç—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π..."

EMPTY_EN=$(grep '= "";' "$EN_FILE" | sed 's/^[[:space:]]*"\([^"]*\)".*/\1/')
EMPTY_RU=$(grep '= "";' "$RU_FILE" | sed 's/^[[:space:]]*"\([^"]*\)".*/\1/')

if [ -n "$EMPTY_EN" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –ü—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∞–Ω–≥–ª–∏–π—Å–∫–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏:${NC}"
    echo "$EMPTY_EN" | sed 's/^/  - /'
    echo ""
fi

if [ -n "$EMPTY_RU" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –ü—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ä—É—Å—Å–∫–æ–π –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏:${NC}"
    echo "$EMPTY_RU" | sed 's/^/  - /'
    echo ""
fi

# –ò—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
if [ -z "$MISSING_IN_RU" ] && [ -z "$MISSING_IN_EN" ] && [ -z "$EMPTY_EN" ] && [ -z "$EMPTY_RU" ]; then
    echo -e "${GREEN}üéâ –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–∞!${NC}"
    exit 0
else
    echo -e "${RED}‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã —Å –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–µ–π${NC}"
    exit 1
fi